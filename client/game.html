<!DOCTYPE html>

<html>

<head>
    <title>Bomb Your Friends!</title>
	<meta charset="utf-8" />
	<link rel="stylesheet" href="resources/css/bootstrap.css" type="text/css" />
	<link href="https://fonts.googleapis.com/css?family=Baloo+Tamma" rel="stylesheet">
	<link rel="stylesheet" href="resources/css/animate.css" type="text/css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
	<style>

		h1 {
			font-family: 'Baloo Tamma';
			font-size: 50px;
		}

		body {			
			text-align: center;
		}

	</style>

    <!--Import scripts-->
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="scripts/bounding_box.js"></script>
    <script src="scripts/background.js"></script>
    <script src="scripts/sprite.js"></script>
    <script src="scripts/ui.js"></script>
    <script src="scripts/registration.js"></script>
    <script src="scripts/player.js"></script>
    <script src="scripts/bomb.js"></script>
    <script src="scripts/power_up.js"></script>
    <script src="scripts/destructable.js"></script>
    <script src="scripts/non_destructable.js"></script>
    <script src="scripts/explosion.js"></script>


    <body>
        <div id="content">
            <div id="gameover" style="display:none;">              
                <div class="container">
                    <div class="well well-sm" style="margin-top:1em;">
                        <div class="row">
                            <div class="col-md-2" >
                                <img src="resources/sprites/gameover.gif" alt="gameover" height="90px">
                            </div>
                            <div class="col-md-8" >
                                <h1 id="winner-message">Player 1 wins!</h1>
                            </div>
                            <div class="col-md-2" >
                                <img src="resources/sprites/gameover.gif" alt="gameover" height="90px">
                            </div>
                        </div>
                        <div style="background: linear-gradient(to right, #232526, #414345); height:500px; border-radius:10px;";>
                            <div class="row" style="padding: 20px 0">
                                <div class="col-md-6" >
                                    <h3>Player 1 Score:</h3>
                                    <strong><h2 id="player1-score"> 60 </h2></strong> 
                                </div>
                                <div class="col-md-6">
                                    <h3>Player 2 Score:</h3>
                                    <strong><h2 id="player2-score"> 70 </h2></strong> 
                                </div>
                            </div>
                                <h3>Leaderboard</h3>
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th style="text-align: center;">Rank</th>
                                            <th style="text-align: center;">Username</th>
                                            <th style="text-align: center;">Score</th>
                                        </tr>
                                    </thead>
                                <tbody id="leaderboard">
                                    <tr>
                                        <td>1</td>
                                        <td>Alice</td>
                                        <td>100</td>
                                    </tr>
                                    <tr>
                                        <td>2</td>
                                        <td>Bob</td>
                                        <td>90</td>
                                    </tr>
                                </tbody>
                                </table>
                        </div>
                        <a class="btn btn-success btn-lg btn-block" href="main.html" role="button">Return to Main Menu</a>
                    </div>
                </div>
                </div>
            </div>
            </div>
            <div id="container">
                <div id="side">
    
                    <div id="countdown" class="well well-sm">2:00</div>
    
                    <div id="info" class="well well-sm">
                        <h3 class="media-heading">Powerups</h3> </br>
                        <img src="resources/sprites/bomb-powerup.png" alt="bomb powerup" style="height:100px"> </br> </br>
                        <p><strong>Bomb Powerup:</strong> Increase the number of bombs you can place.</p></br>
                        <img src="resources/sprites/explosion-powerup.png" alt="fire powerup" style="height:100px"> </br> </br>
                        <p><strong>Fire Powerup:</strong> Increase bomb strength.</p></br>
                        <img src="resources/sprites/speed-powerup.png" alt="speed powerup" style="height:100px"> </br></br>
                        <p><strong>Speed Powerup:</strong> Increase your speed.</p>                        </br>
                        <p>More powerups increase your score!</p>
                    </div>    

    
                </div>
                <div id="main">
                        <div id="game-container" style=" position: relative; ">
                            <!-- Main Game Area-->
                            <canvas id="background" width="850px" height="700px"
                            style="background: #1c1e22; border: 1px solid #0c0d0e; padding: 10px 0;
                            border-radius: 4px; position: absolute; left: 0px; top: 0px; z-index: 0;"> </canvas>
                            <canvas id="entities_canvas" width="850px" height="700px"
                            style="padding: 10px 0; position: absolute; left: 0px; top: 0px; z-index: 1;"> </canvas>
                            <canvas id="bomb_canvas" width="850px" height="700px"
                            style="padding: 10px 0; position: absolute; left: 0px; top: 0px; z-index: 2;"> </canvas>
                        </div>   
                </div>
            </div>
        </div>


        <!--Main Script To run the game-->
        <script>
            $(document).ready(function () {
                
                // HELPER FUNCTIONS
                
                // Seconds to minutes formatting
                function fmtMSS(s){return(s-(s%=60))/60+(9<s?':':':0')+s}
                
                // Transform grid number into x-coordinates for drawing on canvas (0 to 10)
                function toX(col) {
                    // 108, 94 is coordinates of upper left playable corner, add 63 to either to get to adjacent square
                    if (col > 10) col = 10
                    return 108 + col * 63
                }

                // Transform grid number into y-coordinates for drawing on canvas (0 to 8)
                function toY(row) {
                    if (row > 8) row = 8
                    return 94 + row * 63
                }

                // Get playable and non playable grid spaces
                const playable = [];
                const destructableSpace = [];
                const nonDestructableSpace = [];
                let destructablesGrid = [];
                for (var i = 0; i < 11; i++) {
                    for (var j = 0; j < 9; j++) {
                        if (i % 2 && j % 2) {
                            nonDestructableSpace.push([i, j])
                            continue;
                        }
                
                        // Can't have destructable in initial player square and adjacent squares
                        if (i + j > 1 && i + j < 17)
                            destructableSpace.push([i, j]);
        
                        playable.push([i, j]);
                    }

                }
                
                function initializeEntities(d, p, context, destructables, powerups, destructable_type) {
                    /** Randomize destructable and powerup locations, d = number of destructables, p = number of powerups **/
                    // Shuffle array
                    const shuffled = destructableSpace.sort(() => 0.5 - Math.random());

                    // Get sub-array of first n elements after shuffled
                    let selected = shuffled.slice(0, d);
                    let non_selected = shuffled.slice(d + 1, d + 1 + p);
                    selected.forEach(space => {
                        destructables.push(Destructable(context, toX(space[0]), toY(space[1]), destructable_type));
                        destructablesGrid.push([space[0], space[1]]);
                    });
                    non_selected.forEach(space => powerups.push(Powerup(context, toX(space[0]), toY(space[1]), "random")))
                }

                function initializeNonDestructables(context, nonDestructables) {
                    /** Initialize non-destructables **/
                    nonDestructableSpace.forEach(space => nonDestructables.push(NonDestructable(context, toX(space[0]), toY(space[1]))))
                }
                
                function sleep(ms) {
                    return new Promise(resolve => setTimeout(resolve, ms));
                }

                const includesArray = (data, arr) => {
                    return data.some(e => Array.isArray(e) && e.every((o, i) => Object.is(arr[i], o)));
                }



                function createBomb(context, bomb_context, bombs, bomb_number, pos, power) {
                    if (bombs.length < bomb_number) { 
                        bomb = Bomb(bomb_context, toX(pos[0]), toY(pos[1]));
                        bombs.push(bomb);
                        setTimeout( function () {
                            createExplosion(context, explosions, power, pos[0], pos[1]); 
                            sounds.explosion.play();
                        }, 1800);
                    }
                }

                function createExplosion(context, e, power, col, row) {
                    /** Create explosions **/
                    e.push(Explosion(context, toX(col), toY(row), "center"));

                    /* Check if player got hit by explosion */
                    players.forEach((player) => player.checkExplosion(e));

                    for (var i = col + 1; i < col + power; i++) {
                        if (i > 10)
                            break;

                        if (includesArray(nonDestructableSpace, [i, row])) 
                            break;
                        
                        broke = false

                        for (d of destructables.concat(powerups)) {
                            if (d.getXY().x == toX(i) && d.getXY().y == toY(row)) {
                                d.destroy();
                                if (d.getType() == "destructable") broke = true;
                            }
                        }
                        if (broke == true) break;

                        players.forEach((player) => player.checkExplosion([i, row]));

                        if (i == col + power - 1) e.push(Explosion(context, toX(i), toY(row), "right"));

                        else e.push(Explosion(context, toX(i), toY(row), "h_mid"));

           
                    }
                    for (var i = col - 1; i > col - power; i--) {
                        if (i < 0)
                            break;

                        if (includesArray(nonDestructableSpace, [i, row])) 
                            break;
                        
                        broke = false

                        for (d of destructables.concat(powerups)) {
                            if (d.getXY().x == toX(i) && d.getXY().y == toY(row)) {
                                d.destroy();
                                if (d.getType() == "destructable") broke = true;
                            }
                        }
                        if (broke == true) break;

                        players.forEach((player) => player.checkExplosion([i, row]));

                        if (i == col - power + 1) e.push(Explosion(context, toX(i), toY(row), "left"));
                    
                        else e.push(Explosion(context, toX(i), toY(row), "h_mid"));
                        players.forEach((player) => player.checkExplosion(e));

                                  
                    }
          
                    for (var i = row + 1; i < row + power; i++) {
                        if (i > 10)
                            break;

                        if (includesArray(nonDestructableSpace, [col, i])) 
                            break;
                        
                        broke = false

                        for (d of destructables.concat(powerups)) {
                            if (d.getXY().x == toX(col) && d.getXY().y == toY(i)) {
                                d.destroy();
                                if (d.getType() == "destructable") broke = true;
                            }
                        }
                        if (broke == true) break;

                        players.forEach((player) => player.checkExplosion([col, i]));


                        if (i == row + power - 1) e.push(Explosion(context, toX(col), toY(i), "down"));
                
                        else e.push(Explosion(context, toX(col), toY(i), "v_mid"));
                        players.forEach((player) => player.checkExplosion(e));

           
                    }
                    for (var i = row - 1; i > row - power; i--) {
                        if (i < 0)
                            break;

                        if (includesArray(nonDestructableSpace, [col, i])) 
                            break;
                        
                        broke = false

                        for (d of destructables.concat(powerups)) {
                            if (d.getXY().x == toX(col) && d.getXY().y == toY(i)) {
                                d.destroy();
                                if (d.getType() == "destructable") broke = true;
                            }
                        }
                        if (broke == true) break;

                        players.forEach((player) => player.checkExplosion([col, i]));

                        if (i == row - power + 1) e.push(Explosion(context, toX(col), toY(i), "up"));
  
                        else e.push(Explosion(context, toX(col), toY(i), "v_mid"));
                        players.forEach((player) => player.checkExplosion(e));


                    }


                }
                
                
                // Create three canvases, one for background, one for entities, one for bombs
                const bg_cv = $("#background");
                const bg_context = bg_cv[0].getContext("2d");
                const bomb_cv = $("#bomb_canvas");
                const bomb_context = bomb_cv[0].getContext("2d");
                const cv = $("#entities_canvas");
                const context = cv[0].getContext("2d");

                // define the gameArea 
                const gameArea = BoundingBox(context, toY(0), toX(0), toY(8), toX(10));
                corners = gameArea.getPoints();

                // create a Background instance
                // draw the instance
                // x, y are the center of the canvas
                const type_of_background = 0;
                const background = Background(bg_context, 425, 350, type_of_background);
                background.draw();

                /* Create the sprites in the game */
                let destructables = []
                let powerups = []
                let nonDestructables = []
                let bombs_1 = []; 
                let bombs_2 = []; 
                let explosions = [];
                
                initializeEntities(10, 30, context, destructables, powerups, "idle_brick")
                initializeNonDestructables(context, nonDestructables);
                let obstacles = nonDestructables.concat(destructables)
                let entities = powerups.concat(explosions);

                const players = [ 
                    Player(context, toX(0), toY(0), gameArea, 2), 
                    Player(context, toX(10), toY(8), gameArea, 1)
                ]; 

                // Initialise sounds
                const sounds = {
                    background: new Audio("resources/sounds/bomberman.ogg"),
                    bomb: new Audio("resources/sounds/bomb.wav"),
                    explosion: new Audio("resources/sounds/explosion.wav"),
                    item: new Audio("resources/sounds/item.wav"),
                    gameover: new Audio("resources/sounds/gameover.mp3"),
                    cheat: new Audio("resources/sounds/cheat.mp3")
                };
                sounds.cheat.volume = 0.2;
                sounds.explosion.volume = 0.7;
                sounds.background.volume = 0.1;

                const totalGameTime = 120;   // Total game time in seconds
                let gameStartTime = 0;      // The timestamp when the game starts

                /* The main processing of the game */
                function doFrame(now, index=100, gameOver=false, ) {

                    if (gameStartTime == 0) gameStartTime = now;

                    /* Update the time remaining */
                    const gameTimeSoFar = now - gameStartTime;
                    const timeRemaining = Math.ceil((totalGameTime * 1000 - gameTimeSoFar) / 1000);
                    $("#countdown").text(fmtMSS(timeRemaining));

                    if (gameOver == true && index == 0) {
                        sounds.background.pause();
                        if (players[0].getAlive() && !players[1].getAlive()) {
                            players[0].addScore(timeRemaining * 10);
                            $("#winner-message").text("Player 1 wins!")
                        }
                        else if (!players[0].getAlive() && players[1].getAlive()) {
                            players[1].addScore(timeRemaining * 10);
                            $("#winner-message").text("Player 2 wins!")
                        }
                        else $("#winner-message").text("Draw!")
                        updated_leaderboard = []
                        $("#player1-score").text(players[0].getScore().toString());
                        $("#player2-score").text(players[0].getScore().toString());
                        // updated_leaderboard = leaderboard.update(players[0].getScore(), players[1].getScore());
                        // 
                        // $('#leaderboard').empty();
                        // let i = 0
                        // for (ranking of updated_leaderboard) {
                                // let rankCell = ranking.insertCell();
                                // let nameCell = ranking.insertCell();
                                // let scoreCell = ranking.insertCell();
                                // rankCell.textContext = ranking.rank;
                                // nameCell.textContext = ranking.username;
                                // scoreCell.textContext = ranking.score;

                                // if (i >= 10) break;
                                // i += 1;
                        // }
                        $("#container").hide();
                        $("#gameover").show();
                        return;
                    }

                    /* Update the entities, destroy destructables/explosions or use powerups if needed */
                    destructables.forEach((destructable) => {
                        if (destructable.getDestroyed()) {destructables = destructables.filter(d => d !== destructable)}
                    })
                    powerups.forEach((powerup) => {
                        if (powerup.getUsed()) {sounds.item.currentTime = 0; sounds.item.play(); powerups = powerups.filter(p => p !== powerup)}
                    })
                    powerups.forEach((powerup) => {
                        if (powerup.getDestroyed()) {powerups = powerups.filter(p => p !== powerup)}
                    })
                    explosions.forEach((explosion) => {
                        if (explosion.getAge(now) > 600) {explosions = explosions.filter(e => e !== explosion)}
                    })
                    bombs_1.forEach((bomb) => {
                        if (bomb.getAge(now) > 1800) {bombs_1 = bombs_1.filter(b => b !== bomb)}
                    })
                    bombs_2.forEach((bomb) => {
                        if (bomb.getAge(now) > 1800) {bombs_2 = bombs_2.filter(b => b !== bomb)}
                    }) 

                    /* Update the sprites */
                    players.forEach((player) => player.update(now, destructables.concat(nonDestructables), powerups));
                    bombs_1.forEach((bomb) => bomb.update(now));
                    bombs_2.forEach((bomb) => bomb.update(now));
                    powerups.forEach((powerup) => powerup.update(now));
                    destructables.forEach(destructable => destructable.update(now));
                    nonDestructables.forEach(nonDestructable => nonDestructable.update(now));
                    explosions.forEach((explosion) => explosion.update(now));

                    /* Clear the screen */
                    context.clearRect(0, 0, cv[0].width, cv[0].height);
                    bomb_context.clearRect(0, 0, cv[0].width, cv[0].height);

                    /* Draw the sprites */
                    players.forEach((player) => player.draw());
                    bombs_1.forEach((bomb) => bomb.draw());
                    bombs_2.forEach((bomb) => bomb.draw());
                    powerups.forEach((powerup) => powerup.draw());
                    destructables.forEach(destructable => destructable.draw());
                    nonDestructables.forEach(nonDestructable => nonDestructable.draw());
                    explosions.forEach((explosion) => explosion.draw());
                    
                    /* Play a few more frames before game over screen appears */
                    if (timeRemaining <= 0 || !players[0].getAlive() || !players[1].getAlive()) {
                        requestAnimationFrame(function(timestamp) {
                            if (index== 100) sounds.gameover.play();
                            doFrame(timestamp, index-1, true);
                        });
                    }
                    else /* Process the next frame */
                        requestAnimationFrame(doFrame);
                }

                    /* Play background audio */
                    sounds.background.play();

                    /* Handle the keydown of arrow keys and spacebar */
                    $(document).on("keydown", function(event) {

                        /* Handle the key down */
                        switch(event.keyCode) {
                            case 37:
                                players[0].move(1);
                                break;
                            case 38:
                                players[0].move(2);
                                break;
                            case 39:
                                players[0].move(3);
                                break;
                            case 40:
                                players[0].move(4);
                                break;
                            case 32: {
                                sounds.bomb.play();
                                createBomb(context, bomb_context, bombs_1, players[0].getBombNumber(), players[0].getPosition(), players[0].getPower());
                                break;
                            }
                            case 81: {
                                sounds.cheat.currentTime = 0;
                                sounds.cheat.play();
                                players[0].powerUp();
                                break;
                            }
                            case 87: {
                                sounds.cheat.currentTime = 0;
                                sounds.cheat.play();
                                players[0].speedUp();;
                                break;
                            }
                        }

                    });

                    /* Handle the keyup of arrow keys and spacebar */
                    $(document).on("keyup", function(event) {

                        /* Handle the key up */
                        switch(event.keyCode) {
                            case 37:
                                players[0].stop(1);
                                break;
                            case 38:
                                players[0].stop(2);
                                break;
                            case 39:
                                players[0].stop(3);
                                break;
                            case 40:
                                players[0].stop(4);
                                break;
                        }

                    });
                
                /* Start the game */
                
                requestAnimationFrame(doFrame);
            });
        </script>
    
    
    </body>
    
    
    </html>
</head>